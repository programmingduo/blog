---
layout: post
title: "block chains tutorial"
description: "区块链和比特币学习博客"
categories: [block chains and bit coins]
tags: [block chains and bit coins]
redirect_from:
  - /2018/04/26/
---

* Karmdown table of content
{:toc .toc}

**前情：本文主要针对于加密货币当中的区块链应用。并非区块链本身。笔者本人只关心区块链在比特币当中的应用。**

# 一、 区块链的本质

区块链其实就是一种分布式数据库，它的主要作用是存储信息。区块是用来存储数据的数据结构，链保证了存储量级的无限（理论上）延伸。

而在区块链对于比特币而言，便是一个中央记账系统。他存储了所有的交易，分布在无数个节点当中。

# 二、区块链的特点

区块链最大的特点，就在于它是去中心化的。这个特点正是区块链的真正生命力所在。这也是笔者迫不及待想要讲给读者的东西。可以说，这个特点的重要性仅次于区块链的定义以及本质。

所谓去中心化，就是说它是没有中心的。所有的用户在区块链中都只是一个节点，他们之间地位完全平等。并且整个系统刚当中没有管理员。除区块链之外的任何数据库，必定有一个甚至多个管理员，而区块链没有。这也正符合了区块链当初的设计目标。

那么没有管理员这么一个事情为什么能够具有如此之大的魅力呢？原因很简单。没有管理员意味着整个系统无法管理，没有人可以控制整个数据库。否则一旦某些公司或者组织具有管理权，使用者就都必须按照他们的法则和意愿来进行操作了。

讲一个使用中心化系统进行操作的例子。

回忆一下你在网上购买一本书的流程：

> 第一步，你下单并把钱打给支付宝；
>
> 第二步，支付宝收款后通知卖家可以发货了；
>
> 第三步，卖家收到支付宝通知之后给你发货；
>
> 四步，你收到书之后，觉得满意，在支付宝上选择确认收货；
>
> 第五步，支付宝收到通知，把款项打给卖家。流程结束。

你会发现，虽然你是在跟卖家做交易，但是，所有的关键流程都是在跟支付宝打交道。这样的好处在于：万一哪个环节出问题，卖家和买家都可以通过支付宝寻求帮助，让支付宝做出仲裁。这就是一个最简单的基于中心化思维构建的交易模型，它的价值显著，就是建立权威，通过权威背书来获得多方的信任，同时依赖权威方背后的资本和技术实力确保数据的可靠安全。

等下，“通过权威背书来获得多方的信任，同时依赖权威方背后的资本和技术实力确保数据的可靠安全”，真的可以吗？！

假如说，支付宝程序发生重大BUG，导致一段时间内的转账记录全部丢失，或者更彻底一点，支付宝的服务器被金三胖的一个导弹全部炸毁了。而我刚刚转出去的100元找谁说理去，这个时候，你就成了刀殂上的鱼肉；支付宝有良心，会勉为其难承认你刚刚转账的事实，但他不承认你也没辙，因为确实连他自己也不知道这笔转账是否真实存在。

上述就是中心化最大的弊端——过分依赖中心和权威，也就意味着逐渐丧失自己的话语权。中心说什么就是什么。即使你澄清，恐怕也没什么人相信。

当然，去中心化带来的没有管理员也会引出很多需要解决的问题。不然这个系统可能早就实现了不是。那么这些问题都有些什么，需要怎么去解决呢？请你接着往下看。

# 三、区块

先讲区块链当中，区块这个数据结构吧。

我们说过，区块链本身就是一个数据库。这个数据库每次写入数据，都要创建一个新的区块用来存储信息。
区块分为两个部分：

~~~
区块头（Head）：记录当前区块的特征值
区块体（Body）：实际数据
~~~

区块头包含了当前区块的多项特征值。	

~~~~
生成时间
实际数据（即区块体）的哈希
上一个区块的哈希
...
~~~~

![smiley](\assets\images\usedInBlogs\blockChains\0.jpg)

简单解释一下这里所说的哈希。有过计算机基础的人应该对于哈希并不陌生。这里的"哈希"也正是其中的一种应用。具体来讲，计算机可以对任意内容，计算出一个特征值。区块链的 哈希长度是256位，这就是说，不管原始内容是什么，最后都会计算出一个256位的二进制数字。而且可以保证，只要原始内容不同，对应的哈希一定是不同的（理论上，内容不同也有可能得到同一哈希，但是概率极低，可以近似认为不可能发生）。

因此，就有两个重要的推论。

**推论1：每个区块的哈希都是不一样的，可以通过哈希标识区块。**

**推论2：如果区块的内容变了，它的哈希一定会改变。**

区块与哈希是一一对应的，每个区块的哈希都是针对"区块头"（Head）计算的。也就是说，把区块头的各项特征值，按照顺序连接在一起，组成一个很长的字符串，再对这个字符串计算哈希。

~~~~
Hash = SHA256( 区块头 )
~~~~

上面就是区块哈希的计算公式，SHA256是区块链的哈希算法。

前面说过，区块头包含很多内容，其中有当前区块体的哈希，还有上一个区块的哈希。这意味着，如果当前区块体的内容变了，或者上一个区块的哈希变了，一定会引起当前区块的哈希改变。

这一点对区块链有重大意义。如果有人修改了一个区块，该区块的哈希就变了。为了让后面的区块还能连到它（因为下一个区块包含上一个区块的哈希），该人必须依次修改后面所有的区块，否则被改掉的区块就脱离区块链了。由于后面要提到的原因，哈希的计算很耗时，短时间内修改多个区块几乎不可能发生，除非有人掌握了全网51%以上的计算能力。

正是通过这种联动机制，区块链保证了自身的可靠性，数据一旦写入，就无法被篡改。这就像历史一样，发生了就是发生了，从此再无法改变。如果所有人都知道系统的这个特性，那么他们对于这个没有管理员的系统自然会无比信任。

![smiley](\assets\images\usedInBlogs\blockChains\1.png)

每个区块都连着上一个区块，这也是"区块链"这个名字的由来。

对，有个诡异的事情还没讲，整个数据库都只有一条链。。。。一条。。讲道理，如果链条更多的话，先不去讨论是否能够存储更多的信息，单单是存储速度，与链条的个数几乎成正相关的啊，为啥只设计一条呢而放弃这种强大的加速器呢？你先接着往下看吧。

# 四、采矿

这里还有一个比较有意思的事情：中本聪设置了海量的运算来使添加新区块变得很复杂。他的设计是，平均每10分钟，全网才能生成一个新区块，一小时也就六个。

这是为什么呢？几乎所有的技术人员追求的都是快速，而唯独这位骨骼惊奇的本聪大爷，竟会有这种惊人的操作。

其实不难理解，试想一个样例。你刚刚同步了一个区块，生成了自己头部所必须含有的信息————上一区块的哈希值，并且准备基于它生成下一个区块，但这时别的人抢先你一步生成了新的节点，你不得不放弃做了一半的计算，再次去同步。因为每个区块的后面，只能跟着一个区块9所以他叫区块链不叫区块树），你永远只能在最新区块的后面，生成下一个区块。所以，你只能一听到信号，就立刻同步。

在中本聪的设计当中，只有通过极其大量的计算，才能得到当前区块的有效哈希，从而把新区块添加到区块链。由于计算量太大，所以快不起来。

这个过程就叫做采矿（mining），因为计算有效哈希的难度，好比在全世界的沙子里面，找到一粒符合条件的沙子。这就是为什么人们会购买GPU，FPGA，ASIC来挖比特币。计算哈希的机器就叫做矿机，操作矿机的人就叫做矿工。

其实计算哈希的过程本身极为简单，而且计算哈希的过程正是计算机的强项。那么为什么在区块链当中，我们竟然需要花费近十分钟呢？

原来，不是任意一个哈希都可以，只有满足条件的哈希才会被区块链接受。这个条件特别苛刻，使得绝大部分哈希都不满足要求，必须重算。

原来，区块头包含一个难度系数（difficulty），这个值决定了计算哈希的难度。举例来说，第100000个区块的难度系数是 14484.16236122。

![smiley](\assets\images\usedInBlogs\blockChains\2.png)

区块链协议规定，使用一个常量除以难度系数，可以得到目标值（target）。显然，难度系数越大，目标值就越小。

![smiley](\assets\images\usedInBlogs\blockChains\3.png)

哈希的有效性跟目标值密切相关，只有小于目标值的哈希才是有效的，否则哈希无效，必须重算。由于目标值非常小，哈希小于该值的机会极其渺茫，可能计算10亿次，才算中一次。这就是采矿如此之慢的根本原因。

前面说过，当前区块的哈希由区块头唯一决定。如果要对同一个区块反复计算哈希，就意味着，区块头必须不停地变化，否则不可能算出不一样的哈希。区块头里面所有的特征值都是固定的，为了让区块头产生变化，中本聪故意增加了一个随机项，叫做Nonce。

Nonce是一个随机值，矿工的作用其实就是猜出Nonce的值，使得区块头的哈希可以小于目标值，从而能够写入区块链。Nonce是非常难猜的，目前只能通过穷举法一个个试错。根据协议，Nonce是一个32位的二进制值，即最大可以到21.47亿。第100000个区块的Nonce值是274148111，可以理解成，矿工从0开始，一直计算了2.74亿次，才得到了一个有效的Nonce值，使得算出的哈希能够满足条件。

运气好的话，也许一会就找到了Nonce。运气不好的话，可能算完了21.47亿次，都没有发现Nonce，即当前区块体不可能算出满足条件的哈希。这时，协议允许矿工改变区块体，开始新的计算。

# 五、难度系数的动态调节

正如上一节所说，采矿具有随机性，没法保证正好十分钟产出一个区块，有时一分钟就算出来了，有时几个小时可能也没结果。总体来看，随着硬件设备的提升，以及矿机的数量增长，计算速度一定会越来越快。

为了将产出速率恒定在十分钟，中本聪还设计了难度系数的动态调节机制。他规定，难度系数每两周（2016个区块）调整一次。如果这两周里面，区块的平均生成速度是9分钟，就意味着比法定速度快了10%，因此接下来的难度系数就要调高10%；如果平均生成速度是11分钟，就意味着比法定速度慢了10%，因此接下来的难度系数就要调低10%。

难度系数越调越高（目标值越来越小），导致了采矿越来越难。

# 六、区块链的分叉

即使区块链是可靠的，现在还有一个问题没有解决：如果两个人同时向区块链写入数据，也就是说，同时有两个区块加入，因为它们都连着前一个区块，就形成了分叉。这时应该采纳哪一个区块呢？

![smiley](\assets\images\usedInBlogs\blockChains\4.png)

现在的规则是，新节点总是采用最长的那条区块链。如果区块链有分叉，将看哪个分支在分叉点后面，先达到6个新区块（称为"六次确认"）。按照10分钟一个区块计算，一小时就可以确认。

![smiley](\assets\images\usedInBlogs\blockChains\5.png)

由于新区块的生成速度由计算能力决定，所以这条规则就是说，拥有大多数计算能力的那条分支，就是正宗的区块链。

# 七、科普

区块链是以为笔名为中本聪的外国人在2008第一次提出。而中本聪只是其笔名，本人究竟是谁，目前暂时没有相关信息

区块链涉及到分布式数据库，区块链数据结构，密码学的加密算法，共识机制。

区块链是一群分散的客户端节点，并由所有参与者组成的分布式数据库，是对所有比特币交易历史的记录。中本聪预计，当数据量增大之后，用户端希望这些数据并不全部存储自己的节点中。为了实现这一目标，他采用引入散列函数机制。这样客户端将能够自动剔除掉那些自己永远用不到的部分，比方说极为早期的一些比特币交易记录。中本聪创造了比特币系统的第一个区块，即“创世区块”，并附有一句“The Times 03/Jan/2009 Chancellor on brink of second bailout for banks”，而这句是当天泰晤士报的头版文章标题。

区块链作为无人管理的分布式数据库，从2009年开始已经运行了9年。期间发生了令人震惊的[The DAO](https://en.wikipedia.org/wiki/The_Dao)事件以及人们关于分叉的讨论。但是经过努力后加密货币还是依赖于区块链的技术生存了下来。这证明这一技术基本可行。

但是，为了保证数据的可靠性，区块链也有自己的代价。一是效率，数据写入区块链，最少要等待十分钟，所有节点都同步数据，则需要更多的时间；二是能耗，区块的生成需要矿工进行无数无意义的计算，这是非常耗费能源的。

因此，区块链的适用场景，其实非常有限。

> 不存在所有成员都信任的管理当局
>
> 写入的数据不要求实时使用
>
> 挖矿的收益能够弥补本身的成本

如果无法满足上述的条件，那么传统的数据库是更好的解决方案。

![smiley](\assets\images\usedInBlogs\blockChains\6.png)

目前，区块链最大的应用场景（可能也是唯一的应用场景），就是以比特币为代表的加密货币。那么我们就讲讲比特币的故事吧。

由于篇幅原因，请看[下一篇博客](http://wuduo.me/blog/2018/04/28/bit-coins/)。